@model RestaurantSystem.Models.AdminReportsViewModel
@{
    ViewData["Title"] = "Отчеты администратора";
}

<div class="container mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-danger text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>Панель администратора
                </h4>
                <div class="text-end">
                    <small>Отчет на: @DateTime.Now.ToString("dd.MM.yyyy HH:mm")</small>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-primary text-white h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Общая выручка</h5>
                            <h2 class="display-6">@Model.TotalRevenue.ToString("N0") ₽</h2>
                            <p class="card-text">за все время</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-success text-white h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Всего заказов</h5>
                            <h2 class="display-6">@Model.TotalOrders</h2>
                            <p class="card-text">обработано</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-info text-white h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Всего броней</h5>
                            <h2 class="display-6">@Model.TotalBookings</h2>
                            <p class="card-text">@Model.ActiveBookings активных</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-warning text-white h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Дата отчета</h5>
                            <h4 class="mt-2">@Model.ReportDate.ToString("dd.MM.yyyy")</h4>
                            <p class="card-text">@Model.ReportDate.ToString("HH:mm")</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-5">
                <h5 class="mb-3 border-bottom pb-2">
                    <i class="bi bi-cart-check me-2"></i>История заказов
                    <span class="badge bg-secondary">@Model.Orders.Count</span>
                </h5>

                @if (!Model.Orders.Any())
                {
                    <div class="text-center py-4">
                        <i class="bi bi-cart-x display-4 text-muted mb-3"></i>
                        <h5>Заказов пока нет</h5>
                    </div>
                }
                else
                {
                    <div class="accordion" id="ordersAccordion">
                        @foreach (var order in Model.Orders.OrderByDescending(o => o.OrderDate))
                        {
                            <div class="accordion-item mb-2 border">
                                <h2 class="accordion-header" id="order-heading-@order.BookingId">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#order-collapse-@order.BookingId"
                                            aria-expanded="false"
                                            aria-controls="order-collapse-@order.BookingId">
                                        <div class="d-flex justify-content-between w-100 me-3">
                                            <div>
                                                <span class="fw-bold">Заказ #@order.BookingId</span>
                                                <span class="badge @(order.IsClosed ? "bg-secondary" : "bg-success") ms-2">
                                                    @(order.IsClosed ? "Закрыт" : "Активен")
                                                </span>
                                                <span class="badge bg-info ms-1">@order.CustomerInfo</span>
                                                @if (!string.IsNullOrEmpty(order.TableInfo))
                                                {
                                                    <span class="badge bg-warning ms-1">@order.TableInfo</span>
                                                }
                                                @if (order.BookingToken != null && !order.BookingToken.StartsWith("NOBOOK"))
                                                {
                                                    <span class="badge bg-success ms-1">Бронь: @order.BookingToken</span>
                                                }
                                            </div>
                                            <div>
                                                <span class="badge bg-primary me-2">@order.TotalAmount.ToString("N0") ₽</span>
                                                <span class="badge bg-secondary me-2">
                                                    <i class="bi bi-clock"></i>
                                                    @(order.OrderDate?.ToString("dd.MM.yyyy") ?? "-")
                                                    @if (order.OrderTime.HasValue)
                                                    {
                                                        @: @order.OrderTime.Value.ToString(@"hh\:mm")
                                                    }
                                                </span>
                                                <i class="bi bi-chevron-down"></i>
                                            </div>
                                        </div>
                                    </button>
                                </h2>

                                <div id="order-collapse-@order.BookingId" class="accordion-collapse collapse"
                                     aria-labelledby="order-heading-@order.BookingId"
                                     data-bs-parent="#ordersAccordion">
                                    <div class="accordion-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-sm mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Блюдо</th>
                                                        <th width="80">Кол-во</th>
                                                        <th width="100">Цена</th>
                                                        <th width="80">Скидка</th>
                                                        <th width="100">Статус</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in order.Items)
                                                    {
                                                        <tr>
                                                            <td>@item.ItemName</td>
                                                            <td>@item.Quantity</td>
                                                            <td>@item.Price.ToString("N0") ₽</td>
                                                            <td>
                                                                @if (item.Discount.HasValue && item.Discount > 0)
                                                                {
                                                                    <span class="badge bg-success">-@item.Discount%</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">-</span>
                                                                }
                                                            </td>
                                                            <td>
                                                                <span class="badge @(item.Status == 3 ? "bg-secondary" : item.Status == 2 ? "bg-success" : "bg-warning")">
                                                                    @item.StatusText
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                                <tfoot class="table-primary">
                                                    <tr>
                                                        <td colspan="2" class="text-end"><strong>Итого:</strong></td>
                                                        <td><strong>@order.TotalAmount.ToString("N0")</strong> ₽</td>
                                                        <td colspan="2">
                                                            <span class="badge bg-info">@order.Items.Count позиций</span>
                                                        </td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div>
                <h5 class="mb-3 border-bottom pb-2">
                    <i class="bi bi-calendar-check me-2"></i>Бронирования
                    <span class="badge bg-secondary">@Model.Bookings.Count</span>
                </h5>

                @if (!Model.Bookings.Any())
                {
                    <div class="text-center py-4">
                        <i class="bi bi-calendar-x display-4 text-muted mb-3"></i>
                        <h5>Бронирований пока нет</h5>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Токен</th>
                                    <th>Клиент</th>
                                    <th>Контакты</th>
                                    <th>Столик</th>
                                    <th>Дата/Время</th>
                                    <th>Гости</th>
                                    <th>Сумма заказа</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var booking in Model.Bookings.OrderByDescending(b => b.CreatedAt))
                                {
                                    <tr>
                                        <td>#@booking.Id</td>
                                        <td>
                                            <code class="bg-light p-1 rounded">@booking.Token</code>
                                        </td>
                                        <td>@booking.CustomerInfo</td>
                                        <td>
                                            <small>
                                                @if (!string.IsNullOrEmpty(booking.ContactInfo))
                                                {
                                                    @booking.ContactInfo
                                                }
                                                else
                                                {
                                                    <span class="text-muted">нет контактов</span>
                                                }
                                            </small>
                                        </td>
                                        <td>@booking.TableInfo</td>
                                        <td>
                                            <div>@booking.BookingDate.ToString("dd.MM.yyyy")</div>
                                            <small class="text-muted">@booking.BookingTime.ToString(@"hh\:mm")</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info">@booking.GuestsCount чел.</span>
                                        </td>
                                        <td>
                                            @if (booking.OrderTotal.HasValue)
                                            {
                                                <span class="badge bg-success">@booking.OrderTotal.Value.ToString("N0") ₽</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">нет заказа</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @(booking.Status == 1 ? "bg-success" : "bg-secondary")">
                                                @booking.StatusText
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

        <div class="card-footer bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <a asp-controller="Account" asp-action="Dashboard" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Назад в панель
                </a>
                <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i> Отчет обновлен: @DateTime.Now.ToString("dd.MM.yyyy HH:mm")
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        setTimeout(() => {
            location.reload();
        }, 60000);
    </script>

    <style>
        .accordion-button:not(.collapsed) {
            background-color: #f8f9fa;
            color: #212529;
        }

        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
</style>
}